<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Historial de Movimientos - Inventario INA</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<style>
body, html {
  margin: 0; padding: 0; width: 100%; min-height: 100vh;
  font-family: 'Segoe UI', sans-serif;
  background: url("/imagenes/n3.jpg") no-repeat center center fixed;
  background-size: cover;
  display: flex; flex-direction: column;
}

#particles-js { position: fixed; width:100%; height:100%; top:0; left:0; z-index:0; }

.main-container {
  flex: 1; display: flex; flex-direction: column; align-items: center; padding: 20px; z-index:1; position: relative;
}

.card-container {
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(10px);
  border-radius: 15px;
  padding: 25px 20px;
  max-width: 1000px;
  width: 100%;
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.2);
  margin-bottom: 20px;
}

h1, h2 { color: #EDA232; text-align:center; margin-bottom: 20px; }

input.form-control, select.form-control, textarea.form-control {
  border-radius: 10px; margin-bottom: 10px;
}

input.form-control:focus, select.form-control:focus, textarea.form-control:focus {
  box-shadow:0 0 8px #D1903F; border-color:#E68C1C; outline:none;
}

.card-container .btn-primary {
  background-color: #EDA232; border:2px solid #F0AA11; border-radius:50px;
  padding: 5px 12px; font-weight:500; margin-top:5px;
  transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
}
.card-container .btn-primary:hover { transform: scale(1.03); background-color: #CC8023; box-shadow:0 0 8px rgba(239,187,117,0.8); }
a.volver { display:inline-block; margin-top:10px; color:#EDA232; text-decoration:none; font-weight:bold; }
 a.volver:hover { color:#CC8023; }

/* Evitar que se ponga azul al hacer clic */
    .btn-primary:active,
    .btn-primary:focus {
      background-color: #EDA232 !important;
      border-color: #F0AA11 !important;
      box-shadow: 0 0 10px rgba(239, 187, 117, 0.8);
      outline: none;
    }

.table-responsive { overflow-x:auto; }

table { width:100%; border-collapse: collapse; margin-top: 15px; background: rgba(255,255,255,0.85); border-radius: 10px; overflow: hidden; }
th, td { padding:10px; text-align:center; border-bottom:1px solid #EDA232; vertical-align: middle; }
th { background-color: rgba(237,162,50,0.8); color:white; }

td a, td button { font-weight:bold; margin:2px 0; }
td .btn-group-vertical { display:flex; flex-direction:column; gap:5px; }

.badge-returned { background-color: #28a745; color:white; font-size:0.8rem; }
.badge-pending { background-color: #dc3545; color:white; font-size:0.8rem; }

footer { background: rgba(0,0,0,0.5); color: white; padding:12px 0; text-align:center; font-size:0.85rem; margin-top:auto; }

@media(max-width:768px){
  .card-container { padding: 20px 15px; }
  table th, table td { font-size:0.8rem; padding:6px; }
}
</style>
</head>
<body>

<div id="particles-js"></div>
<div class="main-container">

  <% if (user && user.rol === 'docente') { %>
  <div class="card-container">
    <% if (error) { %>
      <div class="alert alert-danger text-center"><%= error %></div>
    <% } %>
    <% if (componenteID && componenteNombre) { %>
      <h2>Registrar movimiento: <%= componenteNombre %> (ID: <%= componenteID %>)</h2>
    <% } else { %>
      <h2>Registrar nuevo movimiento</h2>
    <% } %>

    <form action="/historial" method="POST">
      <% if (componenteID) { %>
        <input type="hidden" name="componente_id" value="<%= componenteID %>">
      <% } else { %>
        <label>ID del componente:</label>
        <input type="number" name="componente_id" class="form-control" required>
      <% } %>
      <select name="movimiento" class="form-control" required>
        <option value="ingreso">Ingreso</option>
        <option value="salida">Salida</option>
        <option value="préstamo">Préstamo</option>
        <option value="devolución">Devolución</option>
      </select>
      <select name="estado" class="form-control" required>
        <option value="">-- Estado --</option>
        <option value="Bien">Bien</option>
        <option value="Regular">Regular</option>
        <option value="Malo">Malo</option>
      </select>
      <input type="number" name="cantidad" class="form-control" placeholder="Cantidad" required min="1">
      <input list="usuarios-list" name="persona" class="form-control" placeholder="Persona">
      <datalist id="usuarios-list">
        <% usuarios.forEach(u => { %>
          <option value="<%= u.nombre %>"><%= u.nombre %> (<%= u.rol %>)</option>
        <% }) %>
      </datalist>
      <textarea name="observaciones" class="form-control" placeholder="Observaciones"></textarea>
      <button type="submit" class="btn btn-primary w-100">Registrar movimiento</button>
    </form>
  </div>
  <% } %>

  <div class="card-container">
    <form method="get" action="/historial/buscar" class="d-flex flex-wrap gap-2 mb-3">
      <input list="usuarios-list" name="persona" class="form-control" placeholder="Buscar por persona">
      <button type="submit" class="btn btn-primary">Buscar</button>
      <a href="/historial" class="btn btn-primary">Limpiar búsqueda</a>
    </form>

    <h2>Movimientos registrados</h2>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Componente</th>
            <th>Movimiento</th>
            <th>Cantidad</th>
            <th>Persona</th>
            <th>Observaciones</th>
            <th>Fecha</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          <% movimientos.forEach(m => { %>
          <tr>
            <td><%= m.id %></td>
            <td><%= m.componente_nombre %></td>
            <td>
              <%= m.movimiento %>
              <% if (m.movimiento.toLowerCase() === 'préstamo') { 
                    const devuelto = movimientos.some(x => x.movimiento.toLowerCase() === 'devolución' && x.componente_id === m.componente_id && x.persona === m.persona && x.fecha > m.fecha); %>
                <% if (devuelto) { %>
                  <span class="badge badge-returned">Devuelto</span>
                <% } else { %>
                  <span class="badge badge-pending">Pendiente</span>
                <% } %>
              <% } %>
            </td>
            <td><%= m.cantidad %></td>
            <td><%= m.persona || '-' %></td>
            <td><%= m.observaciones || '-' %></td>
            <td><%= new Date(m.fecha).toLocaleString() %></td>
            <td>
              <div class="btn-group-vertical">
                <% if (m.movimiento.toLowerCase() === 'préstamo') {
                      const devuelto = movimientos.some(x => x.movimiento.toLowerCase() === 'devolución' && x.componente_id === m.componente_id && x.persona === m.persona && x.fecha > m.fecha);
                      if (!devuelto && user && user.rol === 'docente') { %>
                        <button class="btn btn-success btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#devolverModal"
                          data-id="<%= m.id %>"
                          data-componente="<%= m.componente_nombre %>"
                          data-cantidad="<%= m.cantidad %>"
                          data-persona="<%= m.persona %>">
                          Devolver
                        </button>
                <% } } %>
              </div>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <div class="text-center mt-3">
      <a href="/inventario" class="volver">⬅ Volver al Inventario</a>
    </div>
  </div>

</div>

<!-- Modal Devolución -->
<div class="modal fade" id="devolverModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="devolverForm" method="POST" action="/historial/devolver">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Registrar Devolución</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="prestamo_id" id="prestamo_id">
          <p>Componente: <span id="modalComponente"></span></p>
          <p>Cantidad: <span id="modalCantidad"></span></p>
          <p>Persona: <span id="modalPersona"></span></p>
          <textarea name="observaciones" class="form-control" placeholder="Observaciones..." required></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Registrar devolución</button>
        </div>
      </div>
    </form>
  </div>
</div>

<footer>
  &copy; 2025 Instituto Nuevo Amanecer - Todos los derechos reservados
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
particlesJS("particles-js", {
  "particles": {"number":{"value":40},"color":{"value":"#FFD966"},"shape":{"type":"circle"},"opacity":{"value":0.7},"size":{"value":4},
  "line_linked":{"enable":true,"distance":120,"color":"#ffffff","opacity":0.9,"width":1.5},"move":{"enable":true,"speed":1}},
  "interactivity":{"events":{"onhover":{"enable":true,"mode":"repulse"},"onclick":{"enable":true,"mode":"push"}}},"retina_detect":true
});

const devolverModal = document.getElementById('devolverModal');
devolverModal.addEventListener('show.bs.modal', event => {
  const button = event.relatedTarget;
  document.getElementById('prestamo_id').value = button.getAttribute('data-id');
  document.getElementById('modalComponente').textContent = button.getAttribute('data-componente');
  document.getElementById('modalCantidad').textContent = button.getAttribute('data-cantidad');
  document.getElementById('modalPersona').textContent = button.getAttribute('data-persona');
});
</script>
</body>
</html>
